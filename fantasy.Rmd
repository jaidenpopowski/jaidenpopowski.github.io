---
title: "AFL Fantasy Statistics"
output: html_document
---

<a href="fantasy_projections">AFL Fantasy Score Projections</a>

```{r, echo=F, warning=F, message=F}
library(dplyr)
library(httr)
library(reactable)
library(htmltools)

players <- content(GET('https://fantasy.afl.com.au/data/afl/players.json'),as = "text",encoding = 'UTF-8') %>% jsonlite::fromJSON(flatten = TRUE) %>% 
  transmute(
    playerId = id, 
    Player = paste(first_name,last_name), 
    Average = stats.avg_points, 
    Position = as.character(positions)) %>% 
  mutate(playerId = paste0("CD_I",playerId),Position = stringr::str_replace_all(Position, c("1"="DEF","2"="MID","3"="RUC","4"="FWD",":"="/",", "="/","[()c]"=""))) %>% 
    mutate(playerId = ifelse(playerId == "CD_I1026850","CD_I1012013",playerId))

data <- readRDS("C:/Users/jpopo/Documents/Rstats/Fantasy Score Sources.rds") %>% 
  filter(season == 2024) %>% 
  summarise(across(Fantasy:`Throw In`, ~sum(.x,na.rm=T)/n()),games = n(), .by = c(playerId)) %>% 
  left_join(players,by = "playerId") %>% 
  mutate(Player = stringr::str_replace(Player,"[a-z]+-","-"))

make_table <- function(stat,data_input) {
  
  table_data <- data_input %>% 
    filter(games>=2/3*max(games)) %>%
    select(playerId,Player, G = games, AF = Fantasy, Stat = {{stat}}) %>% 
    slice_max(abs(Stat),n=10,with_ties = F) %>% 
    setNames(c("playerId","Player","G","AF",stat))

  reactable(
    table_data,
    defaultSortOrder = "desc",
    showSortIcon = FALSE,
    showPageSizeOptions = FALSE,
    striped = TRUE,
    sortable = FALSE,
    defaultPageSize = 10,
    #elementId = paste0("fantasy_leaders_",stat),
    style = list(
      fontSize = '12px',
      width = "auto",
      height = "auto"
    ),
    defaultColDef = colDef(
      format = colFormat(digits = 1),
      minWidth = 60,
    ),
    searchable = F,
    columns = list(
      playerId = colDef(show = F),
      Player = colDef(
        name = "Player",
        sticky = "left",
        defaultSortOrder = "asc",
        style = NULL,
        cell=function(value,index){
          image <- img(src = paste0("https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/AFL/2024014/",readr::parse_number(table_data$playerId[index]),".png"), style = "height: 24px;vertical-align:middle")
          tagList(
            div(style = "vertical-align:bottom;",image,paste0(" ",value))
          )},
        minWidth = 150,
        width = 150
      ),
      G = colDef(
        minWidth = 35,
        width = 35,
        style = NULL,
        format = colFormat(digits = 0)
      ),
      AF = colDef(
        name = "AF",
        format = colFormat(digits =1),
        minWidth = 50,
        width = 50
      )
    )
  )
  
}


div(class = "row",
    div(
      class = "sc-leader",
      h3("Stoppage Points (MID)"),
      make_table("Stoppages",data %>% filter(grepl("MID",Position)))
    ),
    div(
      class = "sc-leader",
      h3("Transition Points (MID)"),
      make_table("Transition",data %>% filter(grepl("MID",Position)))
    ),
        div(
      class = "sc-leader",
      h3("Stoppage Points (DEF)"),
      make_table("Stoppages",data %>% filter(grepl("DEF",Position)))
    ),
    div(
      class = "sc-leader",
      h3("Transition Points (DEF)"),
      make_table("Transition",data %>% filter(grepl("DEF",Position)))
    ),
        div(
      class = "sc-leader",
      h3("Stoppage Points (FWD)"),
      make_table("Stoppages",data %>% filter(grepl("FWD",Position)))
    ),
    div(
      class = "sc-leader",
      h3("Transition Points (FWD)"),
      make_table("Transition",data %>% filter(grepl("FWD",Position)))
    ),
        div(
      class = "sc-leader",
      h3("Stoppage Points (RUC)"),
      make_table("Stoppages",data %>% filter(grepl("RUC",Position)))
    ),
    div(
      class = "sc-leader",
      h3("Transition Points (RUC)"),
      make_table("Transition",data %>% filter(grepl("RUC",Position)))
    )
    )


```

<a href="worthwhile_fantasy">Worthwhile Averages for AFL Fantasy 2024</a>

# 2023 Score Sources

<a href="fantasy_score_sources">Player Score Sources</a>

<a href="team_fantasy_sources">Team Score Sources</a>

<a href="fantasy_stoppage_points">Stoppage Points by Round</a> | <a href="fantasy_stoppage_share.html">Stoppage Share (%)</a>

<a href="fantasy_transition_points">Transition Points by Round</a> | <a href="fantasy_transition_share.html">Transition Share (%)</a>

<a href="fantasy_captains_rankings">2023 AFL Fantasy Captains Rankings</a>
