---
title: "Transition Points Share - AFL Fantasy"
output: html_document
---

Transition points measure the amount of points a player scores while their team moves the ball. This is either from an opposition turnover or kick-in, so defenders score a large majority of their points in transition.

Transition share is a market-share analysis where players are ranked based on their proportion of the team's total transition points.

<a href="fantasy_transition_points.html">Transition Points</a> | <a href="fantasy_stoppage_points.html">Stoppage Points</a> | <a href="fantasy_stoppage_share.html">Transition Points Share</a>

```{r, echo = F, warning = F, message = F}
library(dplyr)
library(tidyr)
library(reactable)
library(htmltools)
library(crosstalk)
library(httr)

table <- readRDS("C:/Users/jpopo/Documents/Rstats/Breakdowns.rds") %>% 
  filter(season == 2023) %>% 
    mutate(playerId = ifelse(playerId == "CD_I1012013","CD_I1026850",playerId)) %>% 
  left_join(httr::content(httr::GET('https://fantasy.afl.com.au/data/afl/squads.json'),as = "text",encoding = 'UTF-8') %>% jsonlite::fromJSON(flatten = TRUE), by = join_by(Team == full_name)) %>% 
  left_join(readRDS("C:/Users/jpopo/Documents/Rstats/Worthwhile Averages 2024.rds") %>% transmute(playerId = paste0("CD_I",playerId),Pos = Position), by = "playerId") %>% 
  group_by(season,Round,Team) %>% 
  mutate(team_total = sum(Transition,na.rm=T)) %>% 
  mutate(Share = 100*Transition/sum(Transition,na.rm=T)) %>% 
  ungroup() %>% 
  group_by(season,playerId) %>% 
  mutate(AV = 100*sum(Transition,na.rm=T)/sum(team_total,na.rm=T)) %>% 
  ungroup() %>% 
  select(season,playerId,Player,Pos,Team = short_name,AV,Round,Share) %>% 
  mutate(Share = replace_na(Share,replace = 0L)) %>% 
  arrange(season,Round) %>% 
  pivot_wider(names_from = Round,names_prefix = "R",values_from = Share) %>% select(-season)

round_column <- function(minWidth = 45, digits = 1, ...) {
  colDef(
    minWidth = minWidth,
    format = colFormat(digits = digits),
    style = function(value) {
      if (value >= 10 & !is.na(value)& is.numeric(value)) {
        color <- "#FDE725FF"
      } else if (value >= 8 & !is.na(value)& is.numeric(value)) {
        color <- "#7AD151FF"
      } else if (value >= 6 & !is.na(value)& is.numeric(value)) {
        color <- "#22A884FF"
      } else {
        color <- "white"
      }
      list(background = color)
    },
    ...
  )
}

reactable(
  table,
  defaultSorted = c("AV"),
  defaultSortOrder = "desc",
  showSortIcon = FALSE,
  showPageSizeOptions = TRUE,
  striped = TRUE,
  pageSizeOptions = c(50,100,200),
  defaultPageSize = 50,
  elementId = "stoppagetable",
  style = list(
    fontSize = '12px'
  ),
  defaultColDef = round_column(),
  searchable = T,
  columns = list(
    Player = colDef(
      name = "Player",
      sticky = "left",
      defaultSortOrder = "asc",
      style = NULL,
      cell=function(value,index){
        image <- img(src = paste0("https://fantasy.afl.com.au/assets/media/players/afl/",readr::parse_number(table$playerId[index]),"_450.png"), style = "height: 24px;vertical-align:middle")
        tagList(
          div(style = "vertical-align:bottom;",image,paste0(" ",value))
        )},
      minWidth = 160
    ),
    Team = colDef(
      minWidth = 55,
      style = NULL
    ),
    AV = colDef(
      name = "AV",
      format = colFormat(digits =1),
      minWidth = 40,
      sticky = "left",
      style = list(background = "white")
    ),
    Pos = colDef(
      minWidth = 75,
      style = NULL
    ),
    playerId = colDef(show = F)
  )
)
```

